#!/bin/bash
# <meta:header>
#   <meta:licence>
#     Copyright (C) 2013 by Wizzard Solutions Ltd, ischnura@metagrid.co.uk
#
#     This program is free software: you can redistribute it and/or modify
#     it under the terms of the GNU General Public License as published by
#     the Free Software Foundation, either version 3 of the License, or
#     (at your option) any later version.
#
#     This program is distributed in the hope that it will be useful,
#     but WITHOUT ANY WARRANTY; without even the implied warranty of
#     MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
#     GNU General Public License for more details.
#
#     You should have received a copy of the GNU General Public License
#     along with this program.  If not, see <http://www.gnu.org/licenses/>.
#   </meta:licence>
# </meta:header>
#
#
binpath=$(dirname $(readlink -f ${0}))
srcpath=$(dirname ${binpath:?})
toppath=$(dirname ${srcpath:?})
datpath=${srcpath:?}/dat
tempdir=${toppath:?}/tmp

if [ ! -f "${binpath}/utils" ]
then
    echo "ERROR : unable to load utils [${binpath}/utils]"
    exit -1
else
    source "${binpath}/utils"
fi

#
# Get the configuration data.
sysname=$(hostname -s)

basepool='base'
livepool='live'
connection='qemu:///system'

machines=${datpath:?}/${sysname:?}-machines.txt
template=${datpath:?}/${sysname:?}-template.xml

#
# Check the configuration data.

echo ""
echo "INFO : Base pool  [${basepool:?}]"
echo "INFO : Live pool  [${livepool:?}]"
echo "INFO : Connection [${connection:?}]"

echo ""
echo "INFO : Data path  [${datpath:?}]"
echo "INFO : Temp path  [${tempdir:?}]"

echo ""
echo "INFO : Machines   [${machines:?}]"
echo "INFO : Template   [${template:?}]"

if [ ! -e "${tempdir:?}" ]
then
    mkdir "${tempdir:?}"
fi
if [ ! -e "${tempdir}" ]
then
    echo "ERROR : unable to find temp directory [${tempdir}]"
    exit -1
fi

if [ ! -f "${machines}" ]
then
    echo "ERROR : unable to find machines [${machines}]"
    exit -1
fi

if [ ! -f "${template}" ]
then
    echo "ERROR : unable to find template [${template}]"
    exit -1
fi

#
# Select the machine name.
echo ""
echo "Available machine names"
nodename=''
hostname=$(hostname -s)
nodenames=($(properties "${hostname}" 'name'))
for ((index = 0 ; index < ${#nodenames[@]} ; index++))
do
    echo "[$[index + 1]] ${nodenames[$index]}"
done

nodename=''
while [ "${nodename}" == '' ]
do
    read -p "Select machine name (1) " response
    if [ "${response}" == '' ]
    then
        nodename=${nodenames[0]}
    else
        words=(${response})
        (( index = ${words[0]}  ))
        (( limit = ${#nodenames[@]} ))
        if (( (index > 0) && (index <= limit) ))
        then
            nodename=${nodenames[$[index-1]]}
        fi
    fi
done

#
# Select the base volume.
tempdat=$(mktemp)
virsh --connect "${connection:?}" vol-list --pool "${basepool}" > "${tempdat}"
readarray -t -s 2 lines < "${tempdat}"
basepaths=()
basenames=()
for ((index = 0 ; index < ${#lines[@]} ; index++))
do
    line=${lines[$[index]]}
    if [ -n "${line}" ]
    then
        words=(${line})
        basenames[$index]=${words[0]}
        basepaths[$index]=${words[1]}
    fi
done

echo ""
echo "Available base images"
for ((index = 0 ; index < ${#basenames[@]} ; index++))
do
    echo "[$[index + 1]] ${basenames[$index]}"
done

basepath=''
basename=''
while [ "${basepath}" == '' ]
do
    read -p "Select base image (1) " response
    if [ "${response}" == '' ]
    then
        basepath=${basepaths[0]}
        basename=${basenames[0]}
    else
        words=(${response})
        (( index = ${words[0]} ))
        (( limit = ${#basenames[@]} ))
        if (( (index > 0) && (index <= limit) ))
        then
            basepath=${basepaths[$[index-1]]}
            basename=${basenames[$[index-1]]}
        fi
    fi
done

volsize=8G
#volsize=$(virt-filesystems --long --block-devices -a "${newpath:?}" | sed -n 's|/dev/[a-z]*\s*device\s*\([0-9]*\)\s.*|\1|p')
volsize=$(virsh -c 'qemu:///system' vol-info --pool "${basepool:?}" "${basename:?}" | sed -n 's/Capacity: *\([0-9]*\)\.\([0-9]*\) \([^ ]*\)/\1\3/p')
volname=${nodename:?}.qcow

echo ""
echo "INFO : Node name [${nodename:?}]"
echo "INFO : Base name [${basename:?}]"
echo "INFO : Base path [${basepath:?}]"
echo "INFO : Disc name [${volname:?}]"
echo "INFO : Disc size [${volsize:?}]"
echo ""

confirm "Create virtual machine"
if [ $? -ne 0 ]
then
    echo "EXIT : Cancelled"
    exit 0
fi

#
# Check for existing VM.
prevuuid="$(virsh --connect "${connection:?}" domuuid ${nodename:?} 2>/dev/null)"
if [ -n "${prevuuid}" ]
then
    echo ""
    echo "Found existing virtual machine [${nodename:?}]"
    confirm "Delete existing virtual machine"
    if [ $? -eq 0 ]
    then

# TODO check if it is running.
        virsh --connect "${connection:?}" destroy  "${prevuuid:?}"

        confirm "Delete associated storage"
        if [ $? -eq 0 ]
        then
            virsh --connect "${connection:?}" undefine "${prevuuid:?}" --remove-all-storage
        else
            virsh --connect "${connection:?}" undefine "${prevuuid:?}"
        fi
    else
        echo "EXIT : Found existing virtual machine [${nodename:?}]"
        exit 0
    fi
fi

#
# Check for existing volume.
prevuuid="$(virsh --connect "${connection:?}" vol-key "${volname:?}" --pool "${livepool:?}" 2>/dev/null)"
if [ -n "${prevuuid}" ]
then
    echo ""
    echo "Found existing storage voume [${volname:?}]"
    confirm "Delete storage voume"
    if [ $? -eq 0 ]
    then
        virsh --connect "${connection:?}" vol-delete "${volname:?}" --pool "${livepool:?}"
    else
        echo "EXIT : Found existing storage volume [${volname:?}]"
        exit 0
    fi
fi

#
# Create a new volume, backed by the base image.
virsh --connect "${connection:?}" vol-create-as \
    "${livepool:?}" \
    "${volname:?}" \
    "${volsize:?}" \
    --allocation 0 \
    --format 'qcow2' \
    --backing-vol "${basepath:?}" \
    --backing-vol-format 'qcow2'

virsh --connect "${connection:?}" vol-info --pool "${livepool:?}" "${volname:?}"

#
# Create a new virtual machine.
volpath=$(virsh --connect "${connection:?}" vol-path --pool "${livepool:?}" "${volname:?}")
sed '
    s|<name>.*</name>|<name>'"${nodename:?}"'</name>|
    s|<source file='\''.*'\''/>|<source file='\'''"${volpath}"''\''/>|
    s|<mac address='\''.*'\''/>|<mac address='\'''"$(properties "${nodename:?}" 'mac')"''\''/>|
    ' "${template}" > "${tempdir}/${nodename:?}.xml"


# Define a new (managed) instance
virsh --connect "${connection:?}" define "${tempdir}/${nodename:?}.xml"
virsh --connect "${connection:?}" start  "${nodename:?}"


